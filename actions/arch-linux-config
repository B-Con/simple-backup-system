#!/bin/sh

#
# Backup script by Brad Conte for backing up a personal resource.
# This backs up: Arch Linux system configuration, a skeleton filesystem.
#

# ==============================================================================
# Setup
# ==============================================================================

# Execute global functionality and import global function resources.
BACKUP_GROUP="brad-desktop"

cd "`dirname "$0"`"
source ../config/global.functions


# ==============================================================================
# Main Program
# (Save relevant stuff to pwd)
# ==============================================================================

# ------------------------------------------------------------------------------
# Constants
# ------------------------------------------------------------------------------

# The skeleton filesystem to backup.
BU_LIST=(
	"/home/b-con"
	"/etc"
	"/root"
	"/usr/local/bin"
	"/usr/local/share/applications"
	"/var/abs/local/patches"
	"/var/spool/cron"
	)
PATH_ROOT_FS="$BACKUP_DIR/root-fs"
PATH_PACMAN="$BACKUP_DIR/pacman"


# ------------------------------------------------------------------------------
# Main program
# ------------------------------------------------------------------------------

#
# Save a new skeleton copy of the file system.
#

[ -d "$PATH_ROOT_FS" ] && rm -rf "$PATH_ROOT_FS"
mkdir "$PATH_ROOT_FS"
chown root:root "$PATH_ROOT_FS"
chmod 755 "$PATH_ROOT_FS"
for file in ${BU_LIST[@]} ; do
	if [ -f "$file" -o -d "$file" ]; then
		# Don't copy across mount points as a general rule.
		# This is critical, as $HOME has a few mountpoints that should
		# not be included.
		cp -a --parents --one-file-system "$file" "$PATH_ROOT_FS/"
	fi
done

#
# Save lists of pacman packages.
#

[ -d "$PATH_PACMAN" ] && rm -rf "$PATH_PACMAN"
mkdir "$PATH_PACMAN"
UNOFFICIAL="`pacman -Qqem`"
OFFICIAL="`pacman -Qqe | grep -v \"$UNOFFICIAL\"`"

echo "# Generated by: pacman -Qqem" > "$PATH_PACMAN/pacman-official-explicit"
echo "# ==========" >> "$PATH_PACMAN/pacman-official-explicit"
echo "$OFFICIAL" >> "$PATH_PACMAN/pacman-official-explicit"

echo "# Generated by: pacman -Qqe | grep -v \"\$UNOFFICIAL\"" > "$PATH_PACMAN/pacman-unofficial-explicit"
echo "# ==========" >> "$PATH_PACMAN/pacman-unofficial-explicit"
echo "$UNOFFICIAL" >> "$PATH_PACMAN/pacman-unofficial-explicit"

